#!/bin/bash
#
riverctl map normal Mod4+Mod1 Q exit

export XDG_CURRENT_DESKTOP=river

export MAIN_RATIO="0.55"
export MAIN_HIGH="0.75"
export MAIN_LOW="0.25"
export SCRIPTS="$HOME/.config/river/scripts"
export TILER="rivertile"

activation_vars=(
    WAYLAND_DISPLAY
    DISPLAY
    XDG_CURRENT_DESKTOP
    MOZ_ENABLE_WAYLAND
)

export SCRATCHTAG=$(( 1 << 31 ))
ALL_TAGS=$(( (( 1 << 32 ) - 1) ^ (SCRATCHTAG + ( 1 << 30 )) ))

workspace() {
    while getopts g:m:s:t: flag; do
        case "${flag}" in
        g)  tag_id=$(( (1 << (OPTARG - 1)) + (1 << 30) ))
            riverctl set-focused-tags "${tag_id}"
            echo $tag_id > ~/.cache/rivertag
            ;;
        m)  tag_id=$(( 1 << (OPTARG - 1) ))
            riverctl toggle-view-tags $tag_id
            ;;
        s)  tag_id=$(( 1 << (OPTARG - 1) ))
            riverctl set-view-tags $tag_id
            ;;
        t)  tag_id=$(( 1 << (OPTARG - 1) ))
            riverctl toggle-focused-tags "${tag_id}"
            ;;
        *) echo "Usage: $0 -[g|m|s]"; exit 1 ;;
        esac
    done
}

workspace="$(declare -pf workspace)"

launch() { riverctl spawn "$*"; }
rbind()  { riverctl map "$@"; }
rnbind() { riverctl map normal "$@"; }
input()  { riverctl input "$1" "$2" "$3"; }

for props in tap "natural-scroll"; do
    input "pointer-1739-32382-CUST0001:00_06CB:7E7E_Touchpad" "$props" "enabled"
done

floating_apps=(
    "thunar"
    "pcmanfm"
    "Rofi"
    "org.kde.dolphin"
    "lxqt-policykit-agent"
    "io.github.seadve.Mousai"
)

if [ -z "$(pidof pipewire)" ]; then
    pipewire &
    sleep 1
    pipewire-pulse &
fi

launch "dbus-launch"

! pidof swww-daemon          && launch "swww init" && "$SCRIPTS/wallpaper.sh"
! pidof waybar               && launch "$SCRIPTS/waybar.sh"
! pidof lxqt-policykit-agent && launch "lxqt-policykit-agent"
! pidof mako                 && launch "mako"

riverctl spawn-tagmask $ALL_TAGS

luajit "$HOME/.config/river/init.lua"

## River binds
rnbind Mod4 W         close
rnbind Mod4 M         zoom
rnbind Mod4 F         toggle-fullscreen
rnbind Mod4 T         toggle-float
rnbind Mod4 J         focus-view        next
rnbind Mod4 K         attach-mode       bottom
rnbind Mod4 L         attach-mode       top
rnbind Mod4 Semicolon focus-view        previous

## Floating window movement binds
rbind -repeat normal Mod4+Control J         move left  25
rbind -repeat normal Mod4+Control K         move down  25
rbind -repeat normal Mod4+Control L         move up    25
rbind -repeat normal Mod4+Control Semicolon move right 25

## Floating window resize binds
rbind -repeat normal Mod4+Shift J         resize horizontal "25"
rbind -repeat normal Mod4+Shift K         resize vertical   "-25"
rbind -repeat normal Mod4+Shift L         resize vertical   "25"
rbind -repeat normal Mod4+Shift Semicolon resize horizontal "-25"

## Change window position in stack
rnbind Mod1 J         swap next
rnbind Mod1 Semicolon swap previous

## Scratchpad and sticky window binds
rnbind Mod4       0 toggle-focused-tags $SCRATCHTAG
rnbind Mod4+Shift 0 set-view-tags       $SCRATCHTAG
rnbind Mod4+Shift S toggle-view-tags    $(( 1 << 30 ))

## Application binds
rnbind Mod4         Return spawn "kitty"
rnbind Mod4         Space  spawn "wofi --show drun"
rnbind Mod4+Shift   Space  spawn "wofi --show run"
rnbind Mod4         B      spawn "killall -SIGUSR1 waybar"
rnbind Mod4         E      spawn "pcmanfm"
rnbind Mod4+Shift   B      spawn "$SCRIPTS/waybar.sh"
rnbind Mod4+Shift   Return spawn "kitty"
rnbind Mod1         P      spawn "$SCRIPTS/wallpaper.sh"
rnbind Mod1+Control Delete spawn "$SCRIPTS/rofi-logout-menu"

## Tiling binds
rnbind Mod4       Equal        send-layout-cmd $TILER "main-ratio $MAIN_RATIO"
rnbind Mod4       bracketleft  send-layout-cmd $TILER "main-ratio $MAIN_LOW"
rnbind Mod4       bracketright send-layout-cmd $TILER "main-ratio $MAIN_HIGH"
rnbind Mod4       comma        send-layout-cmd $TILER "main-count +1"
rnbind Mod4       period       send-layout-cmd $TILER "main-count -1"
rnbind Mod4+Shift bar          send-layout-cmd $TILER "main-ratio 0.4"

# Tiling location binds
rnbind Mod4+Mod1 J         send-layout-cmd $TILER "main-location left"
rnbind Mod4+Mod1 K         send-layout-cmd $TILER "main-location bottom"
rnbind Mod4+Mod1 L         send-layout-cmd $TILER "main-location top"
rnbind Mod4+Mod1 Semicolon send-layout-cmd $TILER "main-location right"

# Granular resizing binds
rnbind Mod1+Shift J         send-layout-cmd $TILER "main-ratio -0.01"
rnbind Mod1+Shift Semicolon send-layout-cmd $TILER "main-ratio +0.01"

## Workspace management
for i in $(seq 1 9); do
    rnbind Mod4       "$i" spawn "$workspace; workspace -g $i"
    rnbind Mod1       "$i" spawn "$workspace; workspace -t $i"
    rnbind Mod4+Mod1  "$i" spawn "$workspace; workspace -m $i"
    rnbind Mod4+Shift "$i" spawn "$workspace; workspace -s $i"
done

for mode in normal locked; do
    rbind -repeat $mode None XF86AudioRaiseVolume  spawn "$SCRIPTS/volume -i 5"
    rbind -repeat $mode None XF86AudioLowerVolume  spawn "$SCRIPTS/volume -d 5"
    rbind -repeat $mode None XF86AudioMute         spawn "$SCRIPTS/volume -m 0"
    rbind -repeat $mode None XF86MonBrightnessUp   spawn "$SCRIPTS/brightness -i 2.5"
    rbind -repeat $mode None XF86MonBrightnessDown spawn "$SCRIPTS/brightness -d 2.5"

    rbind $mode None XF86AudioPlay  spawn "playerctl play-pause"
    rbind $mode None XF86AudioPause spawn "playerctl play-pause"
done

## Mouse bindings
riverctl map-pointer normal Mod4 BTN_RIGHT resize-view
riverctl map-pointer normal Mod4 BTN_LEFT  move-view

for app in "${floating_apps[@]}"; do
    riverctl float-filter-add app-id "$app"
done


dbus-update-activation-environment --systemd "${activation_vars[@]}"
systemctl --user import-environment "${activation_vars[@]}"

gsettings set org.gnome.desktop.wm.preferences button-layout ' '
gsettings set org.gnome.desktop.interface cursor-theme "Adwaita"
gsettings set org.gnome.desktop.interface icon-theme   "Papirus-Dark"
gsettings set org.gnome.desktop.interface gtk-theme    "Adw-dark"

riverctl default-layout "$TILER"
exec rivertile -main-ratio $MAIN_RATIO -outer-padding 4 -view-padding 3
